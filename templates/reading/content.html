
{% extends "layout.html" %}

{% block title %}DeutschLernHub - Der geheimnisvolle Brief{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('reading') }}">Reading</a></li>
                    <li class="breadcrumb-item active">Der geheimnisvolle Brief</li>
                </ol>
            </nav>

            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-warning text-dark me-2">B1</span>
                        <span class="badge bg-light text-dark">Short Story</span>
                    </div>
                    <small class="text-muted">150 words | 10 min</small>
                </div>
                <div class="card-body">
                    <h2 class="card-title">Der geheimnisvolle Brief</h2>
                    <h6 class="card-subtitle mb-3 text-muted">The Mysterious Letter</h6>

                    <div class="reading-text mb-4">
                        <p>Anna räumte den Dachboden ihres Großvaters auf. Er war vor einem Monat gestorben, und das alte Haus sollte verkauft werden. Überall standen Kisten mit Erinnerungen. In einer staubigen Holzkiste fand Anna ein kleines, vergilbtes Kuvert. Ihr Name stand darauf, in einer eleganten, aber unbekannten Handschrift.</p>
                        
                        <p>Verwundert öffnete sie den Brief. Darin lag ein altes Foto von ihrem Großvater als junger Mann, zusammen mit einer Frau, die sie nicht kannte. Auf der Rückseite stand: "Für Anna - manchmal führt uns das Leben auf unerwartete Wege. Dies ist die Geschichte deiner wahren Großmutter."</p>
                        
                        <p>Anna setzte sich auf eine alte Truhe und begann zu lesen. Mit jedem Wort enthüllte sich ein Familiengeheimnis, das ihr Leben für immer verändern würde.</p>
                    </div>

                    <div class="vocabulary-section mt-4">
                        <h5>Key Vocabulary</h5>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <div class="vocabulary-item">
                                    <strong>der Dachboden</strong> - the attic
                                    <button class="btn btn-sm btn-link pronounce-word" data-word="Dachboden">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="vocabulary-item">
                                    <strong>vergilbt</strong> - yellowed
                                    <button class="btn btn-sm btn-link pronounce-word" data-word="vergilbt">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="vocabulary-item">
                                    <strong>das Kuvert</strong> - the envelope
                                    <button class="btn btn-sm btn-link pronounce-word" data-word="Kuvert">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Comprehension Questions</h5>
                </div>
                <div class="card-body">
                    <form id="comprehension-form">
                        <div class="mb-4">
                            <p class="mb-2"><strong>1. Wo findet Anna den Brief?</strong></p>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question1" value="0" id="q1o1">
                                <label class="form-check-label" for="q1o1">
                                    Im Wohnzimmer
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question1" value="1" id="q1o2">
                                <label class="form-check-label" for="q1o2">
                                    Auf dem Dachboden
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question1" value="2" id="q1o3">
                                <label class="form-check-label" for="q1o3">
                                    Im Garten
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <p class="mb-2"><strong>2. Was war in dem Brief?</strong></p>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question2" value="0" id="q2o1">
                                <label class="form-check-label" for="q2o1">
                                    Ein Brief von ihrer Mutter
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question2" value="1" id="q2o2">
                                <label class="form-check-label" for="q2o2">
                                    Ein altes Foto mit einer unbekannten Frau
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question2" value="2" id="q2o3">
                                <label class="form-check-label" for="q2o3">
                                    Geld
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Check Answers</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Reading Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2"><i class="fas fa-lightbulb text-warning me-2"></i>Read through the text once without stopping</li>
                        <li class="mb-2"><i class="fas fa-search text-primary me-2"></i>Look up unknown words after the first reading</li>
                        <li class="mb-2"><i class="fas fa-redo text-success me-2"></i>Read the text again for better understanding</li>
                        <li><i class="fas fa-question-circle text-info me-2"></i>Try to answer questions without looking back</li>
                    </ul>
                </div>
            </div>
            {% if current_user.is_authenticated %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Progress</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button id="mark-complete" class="btn btn-success">
                            <i class="fas fa-check-circle me-2"></i>Mark as Complete
                        </button>
                        <button id="save-vocabulary" class="btn btn-outline-primary">
                            <i class="fas fa-bookmark me-2"></i>Save Vocabulary
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const audioCache = new Map();
    
    async function playAudio(word) {
        try {
            if (!audioCache.has(word)) {
                const response = await fetch(`/static/audio/vocabulary/${word.toLowerCase()}.mp3`);
                if (!response.ok) throw new Error('Audio file not found');
                const blob = await response.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                audioCache.set(word, audio);
            }
            const audio = audioCache.get(word);
            audio.currentTime = 0;
            await audio.play();
        } catch (error) {
            console.log("Falling back to AI voice synthesis");
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'de-DE';
            speechSynthesis.speak(utterance);
        }
    }

    document.querySelectorAll('.pronounce-word').forEach(button => {
        button.addEventListener('click', () => {
            const word = button.dataset.word;
            playAudio(word);
        });
    });

    const form = document.getElementById('comprehension-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const correctAnswers = {
                question1: "1",
                question2: "1"
            };

            let score = 0;
            const formData = new FormData(form);
            
            for (const [question, answer] of formData.entries()) {
                if (correctAnswers[question] === answer) {
                    score++;
                }
            }

            const scoreDisplay = document.createElement('div');
            scoreDisplay.className = 'alert alert-info mt-3';
            scoreDisplay.textContent = `Score: ${score}/2`;
            form.appendChild(scoreDisplay);
        });
    }
});
</script>
{% endblock %}
